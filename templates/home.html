<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous" />

  <!-- fontawesome -->
  <script src="https://kit.fontawesome.com/3ea215d505.js" crossorigin="anonymous"></script>

  <title>Main Page</title>
</head>

<body>
  <div class="container py-4 mt-3">
    <div class="d-flex justify-content-center align-items-center">
      <div class="mx-auto d-flex align-items-center">
        <img src="{{ url_for('static', filename='/images/jungle_logo.png')}}" alt="정글 이미지 로고" style="height: 60px"
          class="me-3" />
        <h1 class="text-center display-4 mb-0">TIL JUNGLE</h1>
      </div>
      <div class="d-flex gap-2 me-5">
        <a href="/mypage" class="btn btn-info">
          <i class="fas fa-user me-1"></i>마이페이지
        </a>
        <a href="/post" class="btn btn-success">
          <i class="fas fa-plus me-1"></i>TIL 생성
        </a>
      </div>
    </div>
  </div>

  <!-- 검색 폼 -->
  <div class="container my-4">
    <form class="row justify-content-center" id="searchForm">
      <div class="col-auto">
        <input type="text" class="form-control" placeholder="제목 혹은 태그 검색" id="tagSearchInput" name="tag" />
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">검색</button>
      </div>
    </form>
  </div>

  <!-- 검색 JS -->
  <script>
    let currentKeyword = '';

    document.getElementById('searchForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const keyword = document.getElementById('tagSearchInput').value;

      if (keyword.trim() === '') {
        alert('검색어를 입력해주세요.');
        return;
      }

      currentKeyword = keyword

      $.ajax({
        url: "/models/load_cards",  // POST로 전송
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ keyword: keyword }),
        success: function (response) {
          if (response.result === "success") {
            console.log("카드 검색 성공:", response.cards);
            renderCards(response.cards);
            page = 2
          } else {
            alert("검색 실패: " + response.message);
          }
        },
        error: function (xhr, status, error) {
          alert("에러 발생: " + error);
        }
      });
    });
    
  // 카드 검색시 render하는 함수
  
  function renderCards(cards) {
    const cardList = document.getElementById("card-list");
    cardList.innerHTML = "";  // 기존 카드 삭제

    if (cards.length === 0) {
      cardList.innerHTML = "<p class='text-center'>검색 결과가 없습니다.</p>";
      return;
    }

    for (let card of cards) {
        const cardHtml = `
        <div class="col">
          <div class="card h-100">
            <img
              src="${card.img}"
              class="card-img-top"
              style="height: 160px; object-fit: cover"
              alt="카드 이미지"
            />
            <div class="card-body d-flex flex-column">
              <h5 class="card-title" style="overflow-wrap: break-word">
                ${card.title}
              </h5>

              <p class="card-text mb-1 text-muted">by ${
                card.author
              }</p>

              <p class="card-text">
                ${card.tag_list
                  .map(
                    (tag) =>
                      `<span class="badge bg-secondary">${tag}</span>`
                  )
                  .join(" ")}
              </p>

              <div class="mt-auto d-flex justify-content-between align-items-center">
                <small class="text-muted">${card.date}</small>
                <div class="like-btn">
                  <span class="text-primary" data-id="${card._id}">
                    <i class="fas fa-thumbs-up"></i>
                  </span>
                  <span class="card-likes">${card.likes}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      $("#card-list").append(cardHtml);
    }
  page += 1;
}

</script>

    <!-- 카드 리스트 -->
    <div class="container mt-4">
      <div
        class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4"
        id="card-list"
      >
        {% for card in cards %}
        <div class="col">
          <div class="card h-100">
            <img
              src="{{ card.img }}"
              class="card-img-top"
              style="height: 160px; object-fit: cover"
              alt="카드 이미지"
            />
            <div class="card-body d-flex flex-column">
              <h5 class="card-title" style="overflow-wrap: break-word">
                {{ card.title }}
              </h5>
            <p class="card-text mb-1 text-muted">by {{ card.author }}</p>

            <p class="card-text">
              {% for tag in card.tag_list %}
              <span class="badge bg-secondary">{{ tag }}</span>
              {% endfor %}
            </p>

            <div class="mt-auto d-flex justify-content-between align-items-center">
              <small class="text-muted">{{ card.date }}</small>
              <div class="like-btn">
                <span class="text-primary" data-id="{{ card._id }}">
                  <i class="fas fa-thumbs-up"></i>
                </span>
                <span class="card-likes">{{ card.likes }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
      <div id="scroll-anchor" class="my-4"></div>

  </div>

  <!-- bootstrap js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
</body>

    <!-- bootstrap js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- 무한 스크롤 JS -->
    <script>
      let page = 2;

      const observer = new IntersectionObserver(
        (entries) => {
          if (entries[0].isIntersecting) {
            loadMoreCards();
          }
        },
        {
          rootMargin: "0px 0px 100px 0px",
        }
      );

      observer.observe(document.querySelector("#scroll-anchor"));

      function loadMoreCards() {
        $.ajax({
          type: "GET",
          url: `/models/load_cards?page=${page}&keyword=${encodeURIComponent(currentKeyword)}`,
          success: function (response) {
            if (response.result === "success") {
              const cards = response.cards;
              if (cards.length === 0) {
                observer.disconnect();
                return;
              }
              for (let card of cards) {
                const cardHtml = `
                  <div class="col">
                    <div class="card h-100">
                      <img
                        src="${card.img}"
                        class="card-img-top"
                        style="height: 160px; object-fit: cover"
                        alt="카드 이미지"
                      />
                      <div class="card-body d-flex flex-column">
                        <h5 class="card-title" style="overflow-wrap: break-word">
                          ${card.title}
                        </h5>

                        <p class="card-text mb-1 text-muted">by ${
                          card.author
                        }</p>

                        <p class="card-text">
                          ${card.tag_list
                            .map(
                              (tag) =>
                                `<span class="badge bg-secondary">${tag}</span>`
                            )
                            .join(" ")}
                        </p>

                        <div class="mt-auto d-flex justify-content-between align-items-center">
                          <small class="text-muted">${card.date}</small>
                          <div class="like-btn">
                            <span class="text-primary" data-id="${card._id}">
                              <i class="fas fa-thumbs-up"></i>
                            </span>
                            <span class="card-likes">${card.likes}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                $("#card-list").append(cardHtml);
              }
              page += 1;
            }
          },
        });
      }

      $(document).on("click", ".text-primary", function() {
      const cardId = $(this).data("id");
      const likeCountSpan = $(this).siblings(".card-likes");
        console.log("Clicked cardId:", cardId); // 디버깅용


      $.ajax({
        url: `/models/like_card/${cardId}`,
        type: "POST",
        xhrFields: { withCredentials: true }, 
        success: function(response) {
          if (response.success) {
            likeCountSpan.text(response.likes);
          } else {
            alert("좋아요 실패: " + response.message);
          }
        },
        error: function(xhr) {
          const res = xhr.responseJSON;
          if (res && res.message) {
            alert("좋아요 실패: " + res.message);
          } else {
            alert("좋아요 요청 중 오류가 발생했습니다.");
          }
        },
      });
    });
    </script>
  </body>
</html>
